# AmDb 删除功能说明

## 概述

AmDb支持两种删除操作：
1. **删除记录**：标记删除（由于使用版本管理，数据不会真正删除）
2. **删除数据库**：删除整个数据库目录（不可恢复）

## 删除记录（标记删除）

### 原理

由于AmDb使用版本管理系统，数据不会真正删除，而是通过以下方式实现：

1. **标记删除**：将键的值设置为特殊标记 `__DELETED__`
2. **查询过滤**：`get()` 方法会自动过滤已删除的键，返回 `None`
3. **版本保留**：历史版本仍然保留，可以通过版本查询查看

### CLI 使用

```bash
# 删除单个键
delete <key>

# 示例
delete user:001
```

**交互确认**：
- 系统会要求确认删除操作
- 输入 `y` 确认，其他任何输入都会取消删除

**示例输出**：
```
确定要删除键 'user:001' 吗？(y/N): y
✓ 已标记删除: user:001
提示: 由于使用版本管理，数据不会真正删除，但查询时将返回None
```

### GUI 使用

1. **方法1：工具栏**
   - 选择要删除的记录
   - 点击"删除"按钮
   - 确认删除

2. **方法2：查询执行**
   - 在查询执行标签页输入：`DELETE <key>`
   - 点击"执行查询"

3. **方法3：菜单**
   - 数据 -> 删除（选择记录后）

### 检查删除状态

```python
from src.amdb import Database

db = Database(data_dir='./data/my_db')

# 检查是否已删除
if db.is_deleted(b'user:001'):
    print("键已被删除")
else:
    print("键未删除或不存在")
```

## 删除数据库

### CLI 使用

```bash
# 删除整个数据库
delete database <数据库名称>

# 示例
delete database test_standard_format2
```

**交互确认**：
1. 系统会显示数据库信息（名称、路径、记录数、备注）
2. 要求输入数据库名称以确认
3. 如果当前连接的是要删除的数据库，会自动断开连接

**示例输出**：
```
数据库信息:
  名称: test_standard_format2
  路径: ./data/test_standard_format2
  记录数: 1000
  备注: (无)

警告: 这将删除整个数据库目录: ./data/test_standard_format2
此操作不可恢复！
确定要删除吗？请输入数据库名称 'test_standard_format2' 以确认: test_standard_format2
✓ 数据库已删除: ./data/test_standard_format2
```

### GUI 使用

1. **菜单操作**：
   - 工具 -> 删除数据库
   - 输入数据库名称确认
   - 点击"确认删除"

2. **注意事项**：
   - 只能删除当前连接的数据库
   - 删除前会自动断开连接
   - 此操作不可恢复

## 删除记录的特性

### 优点

1. **数据可追溯**：历史版本仍然保留
2. **可恢复**：可以通过版本管理恢复数据
3. **审计支持**：删除操作会记录在审计日志中

### 限制

1. **不是真正删除**：数据仍然占用存储空间
2. **查询过滤**：已删除的键在查询时返回 `None`
3. **版本管理**：删除操作会创建新版本

## 删除数据库的特性

### 警告

1. **不可恢复**：删除后无法恢复
2. **完全删除**：所有数据、索引、日志都会被删除
3. **需要确认**：必须输入数据库名称确认

### 使用场景

- 清理测试数据库
- 删除不再需要的数据库
- 释放存储空间

## 示例

### 示例1：删除记录

```bash
# CLI
amdb> connect ./data/user_db
amdb [./data/user_db]> delete user:001
确定要删除键 'user:001' 吗？(y/N): y
✓ 已标记删除: user:001

# 验证删除
amdb [./data/user_db]> get user:001
✗ 未找到键: user:001
```

### 示例2：删除数据库

```bash
# CLI
amdb> delete database test_standard_format2
数据库信息:
  名称: test_standard_format2
  路径: ./data/test_standard_format2
  记录数: 1000

警告: 这将删除整个数据库目录: ./data/test_standard_format2
此操作不可恢复！
确定要删除吗？请输入数据库名称 'test_standard_format2' 以确认: test_standard_format2
✓ 数据库已删除: ./data/test_standard_format2
```

### 示例3：Python API

```python
from src.amdb import Database

db = Database(data_dir='./data/my_db')

# 删除记录
success = db.delete(b'user:001')
if success:
    print("已标记删除")

# 检查是否已删除
if db.is_deleted(b'user:001'):
    print("键已被删除")

# 查询已删除的键（返回None）
value = db.get(b'user:001')
print(value)  # None
```

## 注意事项

1. **删除记录**：
   - 数据不会真正删除，只是标记
   - 可以通过版本历史查看删除前的数据
   - 查询时返回 `None`

2. **删除数据库**：
   - 此操作不可恢复
   - 删除前请确保已备份重要数据
   - 如果当前连接的是要删除的数据库，会自动断开

3. **性能影响**：
   - 删除记录会创建新版本，略微影响性能
   - 删除数据库是文件系统操作，速度较快

## 常见问题

### Q: 为什么删除记录后还能通过版本历史查看？

A: 因为使用版本管理，删除只是标记，历史版本仍然保留。这是设计特性，确保数据可追溯。

### Q: 如何真正删除数据？

A: 当前版本不支持真正删除数据。如果需要释放空间，可以：
1. 删除整个数据库
2. 创建新数据库并迁移需要的数据

### Q: 删除数据库会影响其他数据库吗？

A: 不会。每个数据库是独立的目录，删除一个数据库不会影响其他数据库。

