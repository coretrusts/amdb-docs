# AmDb - 区块链优化数据库架构设计

## 设计理念

AmDb（Advanced Merkle Database）是一个专为区块链应用设计的高性能数据库系统，结合了多种数据库的优点，解决了区块链场景下的特殊需求。

## 核心架构

```
┌─────────────────────────────────────────────────────────┐
│                    API Layer (REST/GraphQL)              │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│              Query Engine (查询优化器)                    │
│  - 查询计划优化                                           │
│  - 并行查询执行                                           │
│  - 缓存管理                                               │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────────────────────┐         ┌───────────────────────┐
│   Transaction Layer   │         │   Version Manager     │
│   (事务管理)           │         │   (版本控制)           │
│  - ACID事务            │         │  - 版本链管理          │
│  - 批量写入优化         │         │  - 快照查询           │
│  - 共识接口             │         │  - 历史回溯           │
└───────────────────────┘         └───────────────────────┘
        │                                       │
        └───────────────────┬───────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│              Storage Engine (存储引擎)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  LSM Tree    │  │   B+ Tree    │  │ Merkle Tree  │  │
│  │  (写入优化)   │  │  (读取优化)   │  │  (验证优化)   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│              Index System (索引系统)                      │
│  - 主键索引 (B+树)                                        │
│  - 版本索引 (时间序列)                                    │
│  - Merkle索引 (哈希树)                                    │
│  - 二级索引 (倒排索引)                                    │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│              Persistence Layer (持久化层)                 │
│  - WAL (预写日志)                                         │
│  - SSTable (有序字符串表)                                 │
│  - 压缩存储                                               │
└─────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 混合存储引擎

**LSM树（Log-Structured Merge Tree）**
- 用途：处理高吞吐量写入
- 优势：顺序写入，性能极高
- 实现：MemTable + SSTable

**B+树**
- 用途：快速随机读取
- 优势：低延迟查询
- 实现：内存缓存 + 磁盘存储

**Merkle树**
- 用途：数据完整性验证
- 优势：快速验证，支持增量更新
- 实现：Merkle Patricia Tree

### 2. 不可变版本控制

每个数据项都有版本历史：
```
Key: "account_123"
Version 1: {balance: 100, timestamp: T1, hash: H1}
Version 2: {balance: 150, timestamp: T2, hash: H2, prev: H1}
Version 3: {balance: 200, timestamp: T3, hash: H3, prev: H2}
```

### 3. 智能索引系统

- **主键索引**：B+树，支持O(log n)查询
- **版本索引**：时间序列索引，支持范围查询
- **Merkle索引**：哈希树，支持快速验证
- **二级索引**：倒排索引，支持复杂查询

### 4. 事务系统

- **批量写入**：合并多个操作，减少I/O
- **预写日志**：保证持久性
- **快照隔离**：支持并发读取
- **版本冲突检测**：乐观锁机制

## 性能优化策略

1. **写入优化**
   - 批量写入（Batch Write）
   - 异步刷新（Async Flush）
   - 压缩合并（Compaction）

2. **读取优化**
   - 多级缓存（L1: 内存, L2: SSD, L3: HDD）
   - 预取机制（Prefetch）
   - 查询计划缓存

3. **存储优化**
   - 数据压缩（Snappy/LZ4）
   - 增量存储（Delta Encoding）
   - 冷热分离（Hot/Cold Data）

4. **并发优化**
   - 无锁数据结构（Lock-free）
   - 读写分离
   - 并行查询

## 区块链特性支持

1. **不可变性**
   - 所有写入创建新版本
   - 历史版本永久保存
   - 支持版本回滚查询

2. **可验证性**
   - Merkle根哈希
   - 数据完整性证明
   - 轻量级验证

3. **共识支持**
   - 批量交易处理
   - 状态快照
   - 增量同步

4. **查询能力**
   - 状态查询（最新值）
   - 历史查询（时间点查询）
   - 范围查询
   - 复杂条件查询

