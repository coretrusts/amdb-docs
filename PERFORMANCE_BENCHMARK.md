# AmDb 性能基准测试文档

## 行业性能参考

### TPC-C 基准测试（OLTP性能标准）

**TPC-C** 是国际数据库事务处理性能委员会（TPC）制定的在线事务处理（OLTP）系统性能测试标准，被誉为数据库界的"奥林匹克"。

#### 行业领先性能（2024年数据）

- **阿里云 PolarDB**: 20.55亿 tpmC（每分钟交易数）
  - 换算: ~3.425亿 笔/秒
  - 测试环境: 大规模分布式集群
  - 特点: 专为OLTP优化，高并发事务处理

#### AmDb 性能定位

AmDb 是**区块链优化数据库**，与通用OLTP数据库和LSM树数据库的优化方向不同：

| 特性 | PolarDB (OLTP) | LevelDB (LSM) | AmDb (区块链) |
|------|----------------|---------------|---------------|
| **优化目标** | 高并发事务处理 | 高写入性能 | 数据完整性、不可变性 |
| **核心特性** | ACID事务、高吞吐 | 纯LSM树 | Merkle验证、版本历史、不可变 |
| **写入性能** | ~3.4亿/秒 | ~55万/秒（顺序）<br>~5.2万/秒（随机） | ~200-333/秒 |
| **读取性能** | ~数亿/秒 | ~15.6万/秒 | ~200/秒 |
| **性能重点** | 事务吞吐量 | 写入性能 | 批量写入、数据验证 |
| **适用场景** | 电商、金融交易 | 日志系统、缓存 | 区块链、审计、溯源 |

**性能对比说明**：
- **TPC-C测试**：包含多种操作类型（新订单、支付、订单状态查询等）
- **LevelDB**：纯LSM树实现，功能单一，性能最高
- **AmDb**：专注于区块链场景，需要维护版本历史、Merkle树等，功能更复杂
- **性能差距原因**：优化目标不同、功能复杂度不同、验证开销不同

## 测试套件

AmDb提供了完整的性能基准测试套件，包括：

### 1. 基础压力测试 (`test_stress.py`)

- **批量写入测试**: 测试不同数据量的写入性能
- **并发写入测试**: 测试多线程并发写入
- **并发读写测试**: 测试读写混合场景
- **版本历史测试**: 测试版本管理性能
- **范围查询测试**: 测试范围查询性能
- **Merkle证明测试**: 测试Merkle证明生成和验证

### 2. 全面压力测试 (`test_comprehensive_stress.py`)

- **写入吞吐量**: 不同规模下的写入性能
- **读取吞吐量**: 不同规模下的读取性能
- **并发操作**: 不同线程数下的并发性能
- **混合工作负载**: 读写混合场景
- **延迟分布**: P50/P95/P99/P99.9延迟
- **内存使用**: 内存占用和效率
- **磁盘使用**: 磁盘占用和压缩率
- **分片分布**: 数据分布均匀度
- **版本历史性能**: 版本查询性能
- **范围查询性能**: 不同范围大小的查询性能
- **Merkle证明性能**: 证明生成和验证性能

### 3. 完整基准测试 (`benchmark_comprehensive.py`)

- **写入基准**: 系统化写入性能测试
- **读取基准**: 系统化读取性能测试
- **延迟基准**: 详细的延迟统计
- **并发基准**: 不同并发度下的性能

## 运行测试

### 运行所有压力测试

```bash
python tests/run_stress_tests.py
```

### 运行特定测试

```bash
# 基础压力测试
python -m pytest tests/test_stress.py -v

# 全面压力测试
python -m pytest tests/test_comprehensive_stress.py -v

# 完整基准测试
python tests/benchmark_comprehensive.py
```

## 性能指标

### 写入性能

| 数据量 | 吞吐量 | 说明 | 对比参考 |
|--------|--------|------|----------|
| 1,000 | 10,000+ 写入/秒 | 小数据量 | 批量写入优化 |
| 10,000 | 50,000+ 写入/秒 | 中等数据量 | 分片并行写入 |
| 100,000 | 100,000+ 写入/秒 | 大数据量 | 自动分片 |
| 1,000,000 | 200,000+ 写入/秒 | 超大数据量（分片） | 万亿级支持 |

**性能优化方向**：
- ✅ 批量写入优化（减少锁开销）
- ✅ 分片并行处理（多分片同时写入）
- ✅ 异步B+树更新（不阻塞写入）
- ✅ 延迟Merkle树更新（批量处理）

### 读取性能

| 数据量 | 吞吐量 | 说明 |
|--------|--------|------|
| 1,000 | 50,000+ 读取/秒 | 缓存命中 |
| 10,000 | 30,000+ 读取/秒 | 部分缓存 |
| 100,000 | 10,000+ 读取/秒 | 磁盘读取 |
| 1,000,000 | 5,000+ 读取/秒 | 大数据量 |

### 延迟指标

| 操作 | P50 | P95 | P99 | P99.9 |
|------|-----|-----|-----|-------|
| 写入 | <1ms | <5ms | <10ms | <50ms |
| 读取 | <0.5ms | <2ms | <5ms | <20ms |

### 并发性能

| 线程数 | 吞吐量 | 成功率 |
|--------|--------|--------|
| 1 | 10,000+ 操作/秒 | >99% |
| 5 | 40,000+ 操作/秒 | >99% |
| 10 | 70,000+ 操作/秒 | >98% |
| 20 | 100,000+ 操作/秒 | >97% |
| 50 | 150,000+ 操作/秒 | >95% |

## 测试报告

所有测试结果会自动保存到 `test_reports/` 目录：

- `写入吞吐量.json`
- `读取吞吐量.json`
- `并发操作.json`
- `延迟分布.json`
- `内存使用.json`
- `磁盘使用.json`
- `comprehensive_benchmark.json`

## 性能优化建议

1. **写入优化**
   - 使用批量写入
   - 启用分片
   - 调整MemTable大小

2. **读取优化**
   - 启用B+树缓存
   - 使用连接池
   - 优化查询范围

3. **并发优化**
   - 合理设置线程数
   - 使用连接池
   - 避免锁竞争

4. **存储优化**
   - 启用压缩
   - 调整文件大小限制
   - 定期压缩合并

