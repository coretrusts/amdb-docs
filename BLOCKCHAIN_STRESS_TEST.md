# AmDb 区块链场景压力测试文档

## 概述

AmDb专门针对区块链场景进行了优化，支持长期运行和万亿级数据。本文档描述了区块链场景的压力测试。

## 测试场景

### 1. 大规模账户存储测试

**目标**: 存储千万级账户数据

- **测试规模**: 10,000,000 个账户
- **数据模型**: 账户地址、余额、nonce、代码哈希、存储根
- **性能指标**: 
  - 写入吞吐量: 目标 >100,000 账户/秒
  - 存储效率: 每个账户 <500 字节

### 2. 交易历史测试

**目标**: 存储亿级交易历史

- **测试规模**: 100,000,000 笔交易
- **数据模型**: 交易哈希、发送方、接收方、金额、gas、区块号
- **性能指标**:
  - 写入吞吐量: 目标 >50,000 交易/秒
  - 查询性能: 单笔交易查询 <10ms

### 3. 状态快照性能测试

**目标**: 测试Merkle根生成和验证性能

- **测试规模**: 1,000,000 个状态项
- **性能指标**:
  - 快照创建时间: <5秒
  - 证明验证时间: P99 <5ms

### 4. 长期运行测试

**目标**: 模拟区块链长期运行（30天）

- **测试规模**: 
  - 30天 × 7200区块/天 = 216,000 区块
  - 每区块100-500笔交易
- **性能指标**:
  - 持续写入性能不下降
  - 内存使用稳定
  - 磁盘空间增长可预测

### 5. 万亿级数据测试

**目标**: 验证万亿级数据支持

- **测试规模**: 1,000,000,000 条记录（作为万亿级的子集）
- **分片配置**: 16,384 个分片
- **性能指标**:
  - 写入性能: >10,000 条/秒
  - 分片分布均匀度: CV <0.5

### 6. 并发区块处理测试

**目标**: 测试多线程并发处理区块

- **测试规模**: 10个工作线程，每线程1000个区块
- **性能指标**:
  - 并发吞吐量: >100,000 交易/秒
  - 数据一致性: 100%

### 7. 大规模版本历史测试

**目标**: 测试单个key的大量版本

- **测试规模**: 100,000 个版本
- **性能指标**:
  - 版本创建: >10,000 版本/秒
  - 版本查询: P99 <50ms

### 8. 分片分布分析

**目标**: 验证数据在分片间的均匀分布

- **测试规模**: 100,000,000 条记录
- **性能指标**:
  - 变异系数 (CV): <0.5
  - 最大/最小分片比例: <2:1

## 长期区块链模拟

### 多年运行模拟

模拟区块链多年运行，验证：

1. **数据增长**: 账户数、交易数持续增长
2. **性能稳定性**: 长期运行性能不下降
3. **存储效率**: 磁盘使用效率
4. **分片平衡**: 数据分布保持均匀

### 配置

- **分片数**: 16,384（支持万亿级数据）
- **文件大小限制**: 64MB
- **区块频率**: 每12秒一个区块
- **每区块交易数**: 100-300笔

## 运行测试

### 运行所有区块链压力测试

```bash
python tests/run_blockchain_stress.py
```

### 运行特定测试

```bash
# 大规模账户存储
python -m pytest tests/test_blockchain_stress.py::BlockchainStressTest::test_massive_account_storage -v

# 交易历史测试
python -m pytest tests/test_blockchain_stress.py::BlockchainStressTest::test_transaction_history -v

# 长期运行测试
python -m pytest tests/test_blockchain_stress.py::BlockchainStressTest::test_long_term_operation -v
```

### 运行长期模拟

```bash
python tests/test_blockchain_stress.py
# 然后输入 'yes' 运行长期模拟
```

## 性能目标

### 写入性能

| 场景 | 数据量 | 目标吞吐量 |
|------|--------|-----------|
| 账户存储 | 1000万 | >100,000 账户/秒 |
| 交易历史 | 1亿 | >50,000 交易/秒 |
| 万亿级数据 | 10亿 | >10,000 条/秒 |

### 读取性能

| 场景 | 目标延迟 |
|------|---------|
| 单账户查询 | P99 <5ms |
| 单交易查询 | P99 <10ms |
| 版本查询 | P99 <50ms |

### 存储效率

| 指标 | 目标值 |
|------|--------|
| 账户存储 | <500 字节/账户 |
| 交易存储 | <200 字节/交易 |
| 压缩率 | >50% |

### 分片分布

| 指标 | 目标值 |
|------|--------|
| 变异系数 (CV) | <0.5 |
| 最大/最小比例 | <2:1 |
| 活跃分片率 | >80% |

## 优化建议

### 1. 分片配置

对于万亿级数据：
- **分片数**: 16,384（2^14）
- **文件大小**: 64MB（避免单文件过大）
- **目录结构**: 三级目录（shard_XX/shard_YY/shard_ZZ）

### 2. 批量写入

- 使用批量写入API
- 批量大小: 10,000-50,000 条
- 定期刷新到磁盘

### 3. 索引优化

- 主键索引: 自动维护
- 版本索引: 二分查找优化
- 时间索引: 有序插入

### 4. 缓存策略

- LRU缓存: 热点数据
- 缓存大小: 10,000-100,000 项
- TTL: 根据访问模式设置

## 监控指标

### 关键指标

1. **写入吞吐量**: 每秒写入的记录数
2. **读取延迟**: P50/P95/P99延迟
3. **内存使用**: 内存占用和增长
4. **磁盘使用**: 磁盘占用和增长
5. **分片分布**: 数据分布均匀度
6. **错误率**: 写入/读取错误率

### 告警阈值

- 写入吞吐量下降 >50%
- 读取延迟 P99 >100ms
- 内存使用 >80%
- 磁盘使用 >90%
- 分片分布 CV >0.7

## 总结

AmDb通过以下特性支持区块链场景：

- ✅ **万亿级数据支持**: 16,384个分片
- ✅ **长期运行稳定**: 性能不下降
- ✅ **高并发处理**: 多线程区块处理
- ✅ **版本历史**: 支持大量版本
- ✅ **Merkle证明**: 快速生成和验证
- ✅ **分片平衡**: 数据均匀分布

这些特性使AmDb成为区块链应用的理想数据库选择。

