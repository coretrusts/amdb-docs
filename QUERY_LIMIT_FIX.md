# 查询限制问题修复说明

## 问题描述

用户反馈数据多了之后，分片分页查询不完整：
- `show tables` 只能看到100条
- `select` 只能显示到几千条
- 超过的查不到，包括 `get`

## 问题分析

经过检查，发现以下问题：

1. **`show keys` 命令有硬编码限制**：只显示前100个键
2. **`select * from <prefix>` 命令有硬编码限制**：只显示前100条记录
3. **`get` 方法本身没有问题**：可以读取所有数据，但需要确保从所有存储位置读取

## 修复内容

### 1. 修复 `show keys` 命令

**修改前**：
- 硬编码限制：只显示前100个键
- 无法指定显示更多

**修改后**：
- 默认显示前1000个键（避免输出过多）
- 支持通过 `show keys <limit>` 指定显示数量
- 例如：`show keys 5000` 显示前5000个键

**代码位置**：`src/amdb/cli.py` 的 `_show_keys` 方法

### 2. 修复 `select * from <prefix>` 命令

**修改前**：
- 硬编码限制：只显示前100条记录
- 无法指定显示更多

**修改后**：
- 默认显示前1000条记录（避免输出过多）
- 支持通过 `select * from <prefix> limit <n>` 指定显示数量
- 例如：`select * from block limit 5000` 显示前5000个区块

**代码位置**：`src/amdb/cli.py` 的 `do_select` 方法

### 3. 优化 `get` 方法

**修改前**：
- 优先从版本管理器读取
- 如果版本管理器没有，从存储引擎读取
- 可能遗漏某些存储位置的数据

**修改后**：
- 优先从版本管理器读取
- 如果版本管理器没有，从存储引擎读取（LSM树、B+树、所有分片）
- 如果存储引擎也没有，尝试直接从LSM树读取（可能数据在MemTable中但未刷新到版本管理器）
- 确保可以从所有存储位置读取数据

**代码位置**：`src/amdb/database.py` 的 `get` 方法

## 测试结果

使用 `blockchain_stress_test` 数据库（11100个键）进行测试：

```
1. get_all_keys 返回: 11100 个键 ✓
2. get 方法读取所有键: 11100/11100 成功 (100%) ✓
3. 范围查询:
   - block前缀: 找到 1000 个键 ✓
   - account前缀: 找到 100 个键 ✓
   - tx前缀: 找到 10000 个键 ✓
```

## 使用方法

### 显示所有键

```bash
# 显示前1000个键（默认）
show keys

# 显示前5000个键
show keys 5000

# 显示前10000个键
show keys 10000
```

### 范围查询

```bash
# 查询所有区块（默认显示前1000条）
select * from block

# 查询前5000个区块
select * from block limit 5000

# 查询前10000个交易
select * from tx limit 10000

# 查询所有账户
select * from account limit 100
```

### 单键查询

```bash
# 查询指定键（无限制，可以查询所有数据）
get block:00000001
get account:0x1234567890abcdef
get tx:tx_000001_001
```

## 注意事项

1. **默认限制**：为了避免输出过多导致界面卡顿，默认限制为1000条。如果需要查看更多数据，请使用 `limit` 参数。

2. **性能考虑**：
   - `show keys` 和 `select * from <prefix>` 会遍历所有键，对于大数据量（百万级以上）可能较慢
   - 建议使用 `limit` 参数限制显示数量，或使用更具体的查询条件

3. **数据完整性**：
   - `get_all_keys` 返回所有键（无限制）
   - `get` 方法可以读取所有数据（无限制）
   - 只有显示命令有默认限制，查询功能本身无限制

## 相关文件

- `src/amdb/cli.py` - CLI命令实现
- `src/amdb/database.py` - 数据库核心方法
- `src/amdb/version.py` - 版本管理器（`get_all_keys` 实现）
- `test_query_all_data.py` - 测试脚本

## 修复日期

2026-01-13

